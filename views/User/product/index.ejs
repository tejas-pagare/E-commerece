<body class="bg-green-50 min-h-screen">
    <div id="product-container" class="max-w-6xl mx-auto p-6 bg-white shadow-xl rounded-2xl mt-8">
      <nav class="text-sm text-gray-500 mb-6 flex items-center space-x-2">
        <a href="/api/v1/user" class="hover:underline">Home</a>
        <span>/</span>
        <a href="/api/v1/user/store" class="hover:underline">Shop</a>
        <span>/</span>
        <span id="breadcrumb-title" class="text-gray-700 font-semibold">Loading...</span>
      </nav>

      <div class="md:flex md:space-x-10">
        <div class="md:w-1/2 flex flex-col items-center">
          <div class="w-full flex justify-center">
            <img id="mainImage" src="https://via.placeholder.com/300" alt="Loading product image"
              class="w-72 h-72 object-contain rounded-xl shadow-lg bg-gray-100" />
          </div>
          <div id="thumbnail-gallery" class="flex space-x-4 mt-4">
             </div>
        </div>

        <div class="md:w-1/2 mt-8 md:mt-0">
          <h1 id="product-title" class="text-3xl font-extrabold text-green-900 mb-2">Loading...</h1>
          <span id="product-category" class="text-sm text-green-600 font-medium uppercase tracking-wide"></span>

          <div class="flex items-center mt-4">
            <div class="text-yellow-400 text-lg">
              &#9733;&#9733;&#9733;&#9733;<span class="text-gray-300">&#9733;</span>
            </div>
            <span class="ml-2 text-gray-500 text-sm">(4.0)</span>
          </div>

          <div class="mt-5 flex items-center gap-4">
            <span id="product-price" class="text-2xl font-bold text-green-700"></span>
            <span class="text-gray-400 line-through"></span>
          </div>

          <button id="add-to-cart-btn"
            class="mt-8 bg-green-600 text-white text-lg px-8 py-3 rounded-full font-semibold shadow hover:bg-green-700 transition opacity-50 cursor-not-allowed" disabled>
            <i class="fas fa-shopping-cart mr-2"></i>Add to Cart
          </button>

          <div class="mt-8 text-gray-700 space-y-1 text-sm">
            <p><span class="font-semibold text-green-700">Product Code:</span> <span id="product-code"></span></p>
            <p><span class="font-semibold text-green-700">Availability:</span> <span id="product-availability"></span></p>
            <p><span class="font-semibold text-green-700">Type:</span> <span id="product-type"></span></p>
            <p><span class="font-semibold text-green-700">Shipping:</span> Free Shipping</p>
          </div>
        </div>
      </div>

      <div class="mt-10 md:flex md:space-x-10">
        <div class="md:w-1/2">
          <h3 id="details-category" class="text-xl font-bold text-green-800 mb-2 capitalize"></h3>
          <p id="product-description" class="text-gray-600 mb-4"></p>
          <h3 class="text-xl font-bold text-green-800 mb-2">Storage Tips</h3>
          <p class="text-gray-600">Store in a cool, dry place.</p>
        </div>
      </div>

      <h3 class="text-2xl font-bold mt-12 mb-4 text-green-800">Related Items</h3>
      <div id="related-products-grid" class="grid grid-cols-2 md:grid-cols-4 gap-6">
        </div>
    </div>

    <script>
      // Function to change the main image when a thumbnail is clicked
      function changeImage(src) {
        document.getElementById('mainImage').src = src;
      }
      
      // Notification function
      function showNotification(message, type = 'success') {
        let container = document.querySelector(".notification-container");
        if (!container) {
          container = document.createElement("div");
          container.className = "fixed top-5 right-5 z-50 space-y-2";
          document.body.appendChild(container);
        }
        const notification = document.createElement("div");
        notification.className = `px-4 py-2 rounded-md shadow-md text-white transition-transform transform translate-x-full opacity-0 ${type === "success" ? "bg-green-500" : "bg-red-500"}`;
        notification.textContent = message;
        container.appendChild(notification);
        setTimeout(() => notification.classList.remove("translate-x-full", "opacity-0"), 10);
        setTimeout(() => {
          notification.classList.add("opacity-0", "translate-x-full");
          setTimeout(() => notification.remove(), 200);
        }, 3000);
      }
      
      // Add to Cart function
      async function AddToCart(productId) {
         const btn = document.getElementById('add-to-cart-btn');
         btn.disabled = true;
         btn.innerHTML = '<span class="animate-spin inline-block mr-2">...</span>Adding...';
        try {
          const response = await fetch(`/api/v1/user/cart/add/${productId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
          });
          const data = await response.json();
          if (data.success) {
            showNotification("Item added to cart!", "success");
          } else {
            showNotification(data.message || "Failed to add item!", "error");
          }
        } catch (error) {
          showNotification("Error adding item!", "error");
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-shopping-cart mr-2"></i>Add to Cart';
        }
      }

      document.addEventListener('DOMContentLoaded', function() {
        // Get the product ID from the URL
        const pathParts = window.location.pathname.split('/');
        const productId = pathParts[pathParts.length - 1];
        
        const productContainer = document.getElementById('product-container');
        
        const xhr = new XMLHttpRequest();
        xhr.open('GET', `/api/v1/product/details/${productId}`, true);
        
        xhr.onload = function() {
            if (xhr.status >= 200 && xhr.status < 300) {
                const data = JSON.parse(xhr.responseText);
                if (data.success) {
                    const { product, relatedProducts } = data;

                    // --- Populate Product Details ---
                    document.getElementById('breadcrumb-title').textContent = product.title;
                    document.getElementById('mainImage').src = product.image;
                    document.getElementById('mainImage').alt = product.title;
                    document.getElementById('product-title').textContent = product.title;
                    document.getElementById('product-category').textContent = product.category;
                    document.getElementById('product-price').textContent = `Rs ${product.price}`;
                    document.getElementById('product-code').textContent = product._id;
                    const availability = document.getElementById('product-availability');
                    availability.textContent = product.stock ? 'In Stock' : 'Out of Stock';
                    availability.className = product.stock ? 'text-green-600' : 'text-red-500';
                    document.getElementById('product-type').textContent = product.category;
                    document.getElementById('details-category').textContent = product.category;
                    document.getElementById('product-description').textContent = product.description;

                    // --- Populate Thumbnail Gallery ---
                    const gallery = document.getElementById('thumbnail-gallery');
                    gallery.innerHTML = `
                        <img src="${product.image}" class="thumbnail w-16 h-16 object-contain cursor-pointer rounded-lg border-2 border-green-500" onclick="changeImage(this.src)">
                        <img src="${product.image}" class="thumbnail w-16 h-16 object-contain cursor-pointer rounded-lg border-2 border-green-100 hover:border-green-500 transition" onclick="changeImage(this.src)">
                    `;

                    // --- Enable and configure Add to Cart button ---
                    const addToCartBtn = document.getElementById('add-to-cart-btn');
                    if(product.stock) {
                        addToCartBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        addToCartBtn.disabled = false;
                        addToCartBtn.onclick = () => AddToCart(product._id);
                    }
                    
                    // --- Populate Related Products ---
                    const relatedGrid = document.getElementById('related-products-grid');
                    relatedGrid.innerHTML = ''; // Clear any placeholders
                    if(relatedProducts.length > 0) {
                        relatedProducts.forEach(relProduct => {
                            relatedGrid.innerHTML += `
                                <div class="bg-white shadow-md rounded-xl p-4 flex flex-col items-center hover:shadow-lg transition">
                                    <img src="${relProduct.image}" class="w-28 h-28 object-contain rounded-lg mb-2" alt="${relProduct.title}">
                                    <h4 class="text-sm font-bold text-green-900 mt-2 text-center">${relProduct.title}</h4>
                                    <p class="text-green-600 font-semibold mb-1">Rs.${relProduct.price}</p>
                                    <a href="/api/v1/product/${relProduct._id}"
                                        class="w-full text-center py-2 bg-green-600 text-white rounded-full text-sm font-semibold hover:bg-green-700 transition">View</a>
                                </div>
                            `;
                        });
                    } else {
                        relatedGrid.innerHTML = '<p class="col-span-full text-center text-gray-500">No related items found.</p>';
                    }
                } else {
                    productContainer.innerHTML = `<p class="text-center text-red-500">${data.message}</p>`;
                }
            } else {
                productContainer.innerHTML = '<p class="text-center text-red-500">Error: Could not load product details.</p>';
            }
        };

        xhr.onerror = function() {
            productContainer.innerHTML = '<p class="text-center text-red-500">A network error occurred.</p>';
        };

        xhr.send();
      });
    </script>
  </body>