<body class="bg-green-50 font-sans">
  <div class="flex h-screen">
    <aside class="w-64 bg-green-700 text-white shadow-lg p-6">
      <h2 class="text-2xl font-bold mb-6">Dashboard</h2>
      <nav>
        <ul>
          <li class="mb-4"><a href="#" class="block p-3 bg-green-600 hover:bg-green-500 rounded transition" onclick="showSection('orders')">Orders</a></li>
          <li class="mb-4"><a href="#" class="block p-3 hover:bg-green-600 rounded transition" onclick="showSection('profile')">Profile</a></li>
          <li class="mb-4"><a href="#" class="block p-3 hover:bg-green-600 rounded transition" onclick="showSection('settings')">Settings</a></li>
        </ul>
      </nav>
    </aside>

    <main class="flex-1 p-8 overflow-y-auto">
      <h1 class="text-3xl font-bold mb-6 text-green-800">Welcome, <span id="username-display"><%= username %></span>!</h1>

      <div id="orders" class="content-section bg-white p-6 rounded-lg shadow-lg">
        <h2 class="text-2xl font-semibold mb-4 text-green-700">Recent Orders</h2>
        <table class="w-full border-collapse border border-green-300 rounded-lg overflow-hidden">
          <thead>
            <tr class="bg-green-300 text-green-900">
              <th class="border p-3">Order ID</th>
              <th class="border p-3">Date</th>
              <th class="border p-3">Total</th>
              <th class="border p-3">Status</th>
              <th class="border p-3">Actions</th>
            </tr>
          </thead>
          <tbody id="ordersTableBody">
            <tr>
                <td colspan="5" class="p-3 text-center text-gray-500">Loading order history...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="profile" class="content-section hidden bg-white p-6 rounded-lg shadow-lg">
        <h2 class="text-2xl font-semibold mb-4 text-green-700">Profile</h2>
        <p>Your profile information will be displayed here.</p>
      </div>

      <div id="settings" class="content-section hidden bg-white p-6 rounded-lg shadow-lg">
        <h2 class="text-2xl font-semibold mb-4 text-green-700">Settings</h2>
        <p>Account settings and preferences.</p>
      </div>
    </main>
  </div>

  <div id="orderPopup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="relative bg-white p-6 rounded-lg shadow-xl w-full max-w-lg max-h-[80vh] overflow-y-auto">
      <button class="absolute top-2 right-2 text-gray-600 hover:text-gray-800 text-xl w-8 h-8 flex items-center justify-center" onclick="closePopup()">âœ–</button>
      <h2 class="text-2xl font-semibold text-green-700 mb-4">Order Details</h2>
      <div id="popupContent"></div>
      <button class="mt-4 px-5 py-2 bg-green-600 hover:bg-green-500 text-white rounded transition" onclick="closePopup()">Close</button>
    </div>
  </div>

  <script>
    function showSection(sectionId) {
      document.querySelectorAll('.content-section').forEach(section => {
        section.classList.add('hidden');
      });
      document.getElementById(sectionId).classList.remove('hidden');
    }

    function viewDetails(productsJson) {
        // The JSON is passed as a string, so we need to parse it
        const products = JSON.parse(decodeURIComponent(productsJson));
        const popupContent = document.getElementById("popupContent");
        
        if (!products || products.length === 0) {
            popupContent.innerHTML = '<p>No product details available for this order.</p>';
        } else {
            popupContent.innerHTML = products.map(item => {
                const product = item.productId || {}; // Handle cases where productId might be null
                return `
                <div class="p-3 border-b text-left">
                  <div class="flex items-center space-x-4">
                    <img src="${product.image || 'https://via.placeholder.com/80'}" alt="${product.name || 'Product Image'}" class="w-20 h-20 object-cover rounded">
                    <div>
                      <p class="font-semibold">${product.name || 'Unknown Product'}</p>
                      <p><strong>Price:</strong> Rs.${item.price}</p>
                      <p><strong>Quantity:</strong> ${item.quantity}</p>
                      <p><strong>Category:</strong> ${product.category || 'N/A'}</p>
                    </div>
                  </div>
                </div>
              `;
            }).join("");
        }
        document.getElementById("orderPopup").classList.remove("hidden");
    }

    function closePopup() {
      document.getElementById("orderPopup").classList.add("hidden");
    }
    
    
    document.addEventListener('DOMContentLoaded', function() {
        const tableBody = document.getElementById('ordersTableBody');
        
        const xhr = new XMLHttpRequest();
        xhr.open('GET', '/api/v1/user/order-history', true);
        
        xhr.onload = function() {
            if (xhr.status >= 200 && xhr.status < 300) {
                const data = JSON.parse(xhr.responseText);
                const orders = data.orders || [];

                tableBody.innerHTML = ''; // Clear loading message

                if (orders.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="p-3 text-center text-gray-500">You have no past orders.</td></tr>';
                    return;
                }

                orders.forEach(order => {
                    // We need to stringify and encode the products array to pass it safely in an HTML attribute
                    const productsJson = encodeURIComponent(JSON.stringify(order.products));
                    const row = `
                        <tr class="hover:bg-green-100 transition">
                            <td class="border p-3 text-center">${order.orderId}</td>
                            <td class="border p-3 text-center">${new Date(order.purchaseDate).toLocaleDateString()}</td>
                            <td class="border p-3 text-center">Rs.${order.totalAmount}</td>
                            <td class="border p-3 text-center">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">${order.status}</span>
                            </td>
                            <td class="border p-3 text-center">
                                <button 
                                    class="px-4 py-2 bg-green-600 hover:bg-green-500 text-white rounded transition"
                                    onclick='viewDetails("${productsJson}")'>
                                    Details
                                </button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            } else {
                 tableBody.innerHTML = '<tr><td colspan="5" class="p-3 text-center text-red-500">Failed to load order history.</td></tr>';
            }
        };

        xhr.onerror = function() {
            tableBody.innerHTML = '<tr><td colspan="5" class="p-3 text-center text-red-500">A network error occurred.</td></tr>';
        };

        xhr.send();
    });
  </script>
</body>